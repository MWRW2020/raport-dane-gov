# Nazwa całego procesu automatyzacji
name: Codzienne generowanie raportu dla dane.gov.pl

on:
  # Uruchamia proces automatycznie codziennie
  # W przykładzie użyto 49 22 UTC, co odpowiada nocy w Polsce (po północy czasu polskiego)
  schedule:
    - cron: '49 22 * * *' 
  # Umożliwia ręczne uruchomienie procesu w interfejsie GitHub
  workflow_dispatch: 

# Definiuje uprawnienia wymagane dla automatu
permissions:
  # Użycie 'write' jest krytyczne dla akumulacji, ponieważ pozwala na commit zmienionych plików XML/MD5 z powrotem do repozytorium
  contents: write # KONIECZNE DLA AKUMULACJI [1, 8, 10]
  pages: write 
  id-token: write 

# Definiuje zadania do wykonania
jobs:
  # Zadanie 1: Generowanie plików, akumulacja i przygotowanie artefaktu
  build:
    runs-on: ubuntu-latest
    steps:
      # Krok 1: Pobranie kodu repozytorium na serwer wirtualny. Umożliwia odczyt i zapis.
      - name: Checkout repository (Read/Write)
        uses: actions/checkout@v3 
        with:
          # Użycie GITHUB_TOKEN dla uprawnień do zapisu
          token: ${{ secrets.GITHUB_TOKEN }} 

      # Krok 2: Ustawienie środowiska Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      # Krok 3: Uruchomienie skryptu Pythona do generowania plików XML i MD5
      # Skrypt działa w trybie AKUMULACJI: wczytuje istniejący XML, dodaje nowy <resource> i nadpisuje XML/MD5.
      - name: Run script to generate XML and MD5 (Accumulation Mode)
        run: python generator_danych_gov.py
        
      # Krok 4: Przygotowanie dziennego pliku z danymi (kopiowanie wzorca XLSX/CSV)
      # Ten plik jest wymagany, aby codzienny wpis <resource> w XML mógł wskazywać na unikalny URL [11-14].
      - name: Prepare daily data file (XLSX/CSV)
        run: | 
          # POBIERANIE ZMIENNYCH Z PLIKU CONFIG W PYTHONIE
          INWESTYCJA_ID=$(python -c "from generator_danych_gov import CONFIG; print(CONFIG['INWESTYCJA_ID'])") 
          TODAY_STR=$(date +'%Y-%m-%d')
          # Kopiowanie wzorca na unikalną, datowaną nazwę
          cp dane_wzor.xlsx "ceny-${INWESTYCJA_ID}-${TODAY_STR}.xlsx"
          
      # ***************************************************************
      # KROK 5: ZAPISANIE ZAAKUMULOWANYCH PLIKÓW Z POWROTEM DO GAŁĘZI 'MAIN'
      # TEN KROK JEST KRYTYCZNY DLA AKUMULACJI DANYCH!
      # Gwarantuje, że plik XML z danymi z poprzednich dni będzie dostępny przy kolejnym uruchomieniu skryptu [8, 10].
      - name: Commit accumulated files back to main branch
        # Używamy akcji auto-commit do zatwierdzenia zmian
        uses: stefanzweifel/git-auto-commit-action@v5 
        with:
          commit_message: "Automatyczna aktualizacja: Dodanie dziennego raportu do XML/MD5"
          # Wzór plików, które mają zostać zapisane: XML, MD5 oraz dzienny plik z danymi (XLSX)
          file_pattern: "*.xml *.md5 *.xlsx" 
      # ***************************************************************
          
      # Krok 6: Spakowanie wszystkich wygenerowanych plików do "artefaktu" gotowego do publikacji
      - name: Upload artifact for deployment
        uses: actions/upload-pages-artifact@v3
        with:
          # Ścieżka, z której pakujemy pliki (cały katalog roboczy, zawierający XML, MD5 i XLSX)
          path: .
          
  # Zadanie 2: Publikacja strony z "artefaktu" (Deployment)
  deploy:
    # To zadanie musi czekać na pomyślne ukończenie zadania 'build' (generowanie i commit)
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      # Krok 7: Użycie oficjalnej akcji do publikacji strony z przygotowanego artefaktu
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
