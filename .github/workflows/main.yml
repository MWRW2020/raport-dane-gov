name: 叼 Generowanie XML i publikacja na GitHub Pages

on:
  push:
    branches:
      - main
  schedule:
    # Uruchomienie o p贸nocy (00:00 UTC) ka偶dego dnia
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  generate_and_publish:
    runs-on: ubuntu-latest
    
    # Ustawienie uprawnie do repozytorium
    permissions:
      contents: write 
      pages: write    
      id-token: write 

    steps:
      - name: 1. Checkout repository (Read/Write)
        uses: actions/checkout@v4

      - name: 2. Konfiguracja rodowiska Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: 2.5. CZYSZCZENIE AWARYJNE (Nuklearne)
        # Ten krok usuwa WSZYSTKIE znaki kontrolne (np. ukryte spacje) z bie偶cego pliku.
        run: |
          echo "Wykonywanie nuklearnego czyszczenia generator_danych_gov.py..."
          tr -cd '\11\12\15\40-\377' < generator_danych_gov.py > temp_clean.py
          mv temp_clean.py generator_danych_gov.py
          echo "Plik zosta ekstremalnie wyczyszczony."

      - name: 2.6. AWARYJNE NADPISANIE PLIKU PYTHON
        id: overwrite
        # TEN KROK NADPISUJE CAY PLIK generator_danych_gov.py CZYSTYM KODEM.
        # Sprawdzibym to w pierwszej kolejnoci, gdyby bd by tak uparty.
        # U偶yj wasnych wartoci staych (DEWELOPER_NAME, DEWELOPER_EXTIDENT, itp.)!
        run: |
          cat << EOF > generator_danych_gov.py
          import xml.etree.ElementTree as ET
          from datetime import date, timedelta
          import hashlib
          from xml.dom import minidom
          import os
          import re

          # --- Konfiguracja (ZMIE TE WARTOCI NA SWOJE) ---
          DEWELOPER_NAME = "MWRW Sp. z o.o."
          DEWELOPER_EXTIDENT = "9543cc89-477f-4e21-b865-2aef92679a20" 
          RESOURCE_BASE_URL = "https://mwrw2020.github.io/raport-dane-gov"
          ACTUAL_DATA_FILENAME = "dane_wzor.xlsx"
          MAX_HISTORY_DAYS = 3000
          XML_FILE_NAME = "raport_cen_mieszkan.xml"
          MD5_FILE_NAME = "raport_cen_mieszkan.md5"
          NS = {'ns2': 'urn:otwarte-dane:harvester:1.13'}
          # ----------------------------------------------------

          TODAY_DATE = date.today()
          TODAY_DATE_STR = TODAY_DATE.isoformat() 
          TODAY_DATE_ID = TODAY_DATE.strftime("%Y%m%d")
          RESOURCE_EXTIDENT_TODAY = f"ZASOB_{DEWELOPER_EXTIDENT}_{TODAY_DATE_ID}"

          def prettify_xml(elem):
              ET.register_namespace('ns2', NS['ns2'])
              xml_string = ET.tostring(elem, encoding='utf-8').decode('utf-8')
              reparsed = minidom.parseString(xml_string)
              return reparsed.toprettyxml(indent="  ")

          def create_base_dataset():
              dataset = ET.Element(f"{{{NS['ns2']}}}dataset", attrib={'status': 'published'})
              ET.SubElement(dataset, 'extIdent').text = DEWELOPER_EXTIDENT
              
              title = ET.SubElement(dataset, 'title')
              ET.SubElement(title, 'polish').text = f"Ceny ofertowe mieszka dewelopera {DEWELOPER_NAME} w {TODAY_DATE.year} r."
              ET.SubElement(title, 'english').text = f"Offer prices of apartments of developer {DEWELOPER_NAME} in {TODAY_DATE.year}."
              
              description = ET.SubElement(dataset, 'description')
              desc_base = "Zbi贸r danych zawiera informacje o cenach ofertowych mieszka dewelopera udostpniane zgodnie z art. 19b. ust. 1 Ustawy z dnia 20 maja 2021 r. o ochronie praw nabywcy lokalu mieszkalnego lub domu jednorodzinnego oraz Deweloperskim Funduszu Gwarancyjnym (Dz. U. z 2024 r. poz. 695)."
              ET.SubElement(description, 'polish').text = desc_base
              ET.SubElement(description, 'english').text = desc_base.replace("Zbi贸r danych zawiera informacje", "The dataset contains information")

              # Metadane techniczne zbioru (Bezpieczna skadnia)
              
              update_freq_elem = ET.SubElement(dataset, 'updateFrequency')
              update_freq_elem.text = 'daily'
              
              dynamic_data_elem = ET.SubElement(dataset, 'hasDynamicData')
              dynamic_data_elem.text = 'false'
              
              high_value_data_elem = ET.SubElement(dataset, 'hasHighValueData')
              high_value_data_elem.text = 'true'
              
              high_value_ec_elem = ET.SubElement(dataset, 'hasHighValueDataFromEuropeanCommissionList')
              high_value_ec_elem.text = 'false'
              
              research_data_elem = ET.SubElement(dataset, 'hasResearchData')
              research_data_elem.text = 'false'
              
              # Kategoria: Gospodarka i finanse (Bezpieczna skadnia)
              categories = ET.SubElement(dataset, 'categories')
              category_elem = ET.SubElement(categories, 'category')
              category_elem.text = 'ECON' 
              
              tags = ET.SubElement(dataset, 'tags')
              ET.SubElement(tags, 'tag', attrib={'lang': 'pl'}).text = 'Deweloper'

              ET.SubElement(dataset, 'resources')
              
              return dataset

          def create_resource_element(data_date_str):
              data_date_id = data_date_str.replace('-', '')
              resource_extident = f"ZASOB_{DEWELOPER_EXTIDENT}_{data_date_id}"
              
              resource = ET.Element('resource', attrib={'status': 'published'})
              ET.SubElement(resource, 'extIdent').text = resource_extident 
              ET.SubElement(resource, 'url').text = f"{RESOURCE_BASE_URL}/{ACTUAL_DATA_FILENAME}" 
              
              res_title = ET.SubElement(resource, 'title')
              ET.SubElement(res_title, 'polish').text = f"Ceny ofertowe mieszka dewelopera {DEWELOPER_NAME} {data_date_str}"
              ET.SubElement(res_title, 'english').text = f"Offer prices for developer's apartments {DEWELOPER_NAME} {data_date_str}"

              res_description = ET.SubElement(resource, 'description')
              res_desc_text = f"Dane dotyczce cen ofertowych mieszka dewelopera {DEWELOPER_NAME} udostpnione {data_date_str} zgodnie z art. 19b. ust. 1 Ustawy z dnia 20 maja 2021 r. o ochronie praw nabywcy lokalu mieszkalnego lub domu jednorodzinnego oraz Deweloperskim Funduszu Gwarancyjnym (Dz. U. z 2024 r. poz. 695)."
              ET.SubElement(res_description, 'polish').text = res_desc_text
              ET.SubElement(res_description, 'english').text = res_desc_text.replace("Dane dotyczce cen ofertowych", "Data on offer prices")

              ET.SubElement(resource, 'availability').text = 'local'
              ET.SubElement(resource, 'dataDate').text = data_date_str 

              special_signs = ET.SubElement(resource, 'specialSigns')
              ET.SubElement(special_signs, 'specialSign').text = 'X' 

              # Dodatkowe metadane zasobu (Bezpieczna skadnia)
              
              res_dynamic_data_elem = ET.SubElement(resource, 'hasDynamicData')
              res_dynamic_data_elem.text = 'false'
              
              res_high_value_data_elem = ET.SubElement(resource, 'hasHighValueData')
              res_high_value_data_elem.text = 'true'
              
              res_high_value_ec_elem = ET.SubElement(resource, 'hasHighValueDataFromEuropeanCommissionList')
              res_high_value_ec_elem.text = 'false'
              
              res_research_data_elem = ET.SubElement(resource, 'hasResearchData')
              res_research_data_elem.text = 'false'
              
              res_protected_data_elem = ET.SubElement(resource, 'containsProtectedData')
              res_protected_data_elem.text = 'false'
              
              return resource

          def generate_xml_and_md5():
              
              dataset_tag = f"{{{NS['ns2']}}}dataset"
              resources_tag = f"{{{NS['ns2']}}}resources"
              resource_tag = f"{{{NS['ns2']}}}resource"
              extident_tag = f"{{{NS['ns2']}}}extIdent"
              data_date_tag = f"{{{NS['ns2']}}}dataDate"

              if os.path.exists(XML_FILE_NAME):
                  print(f"Znaleziono istniejcy plik {XML_FILE_NAME}. Aktualizacja...")
                  try:
                      for prefix, uri in NS.items():
                          ET.register_namespace(prefix, uri)
                          
                      tree = ET.parse(XML_FILE_NAME)
                      root = tree.getroot()
                      
                      dataset = root.find(dataset_tag)
                      resources_container = dataset.find(resources_tag)

                      if dataset is None or resources_container is None:
                          if dataset is None:
                              dataset = create_base_dataset()
                              root.append(dataset)
                              resources_container = dataset.find(resources_tag)
                          elif resources_container is None:
                              resources_container = ET.SubElement(dataset, resources_tag.split('}')[-1])
                          
                          print("Przywr贸cono brakujce elementy XML.")

                  except Exception as e:
                      print(f"Bd podczas parsowania XML ({e}). Tworzenie nowej struktury.")
                      root = ET.Element(f"{{{NS['ns2']}}}datasets",
                                        attrib={'xmlns:xsi': "http://www.w3.org/2001/XMLSchema-instance"})
                      dataset = create_base_dataset()
                      root.append(dataset)
                      resources_container = dataset.find(resources_tag)

              else:
                  print(f"Nie znaleziono pliku {XML_FILE_NAME}. Tworzenie od podstaw.")
                  root = ET.Element(f"{{{NS['ns2']}}}datasets",
                                    attrib={'xmlns:xsi': "http://www.w3.org/2001/XMLSchema-instance"})
                  dataset = create_base_dataset()
                  root.append(dataset)
                  resources_container = dataset.find(resources_tag)

              for res in resources_container.findall(resource_tag):
                  ext_ident_elem = res.find(extident_tag)
                  if ext_ident_elem is not None and ext_ident_elem.text == RESOURCE_EXTIDENT_TODAY:
                      resources_container.remove(res)
                      print(f"Zas贸b dla dnia {TODAY_DATE_STR} zosta zastpiony.")
                      break
                      
              new_resource = create_resource_element(TODAY_DATE_STR)
              resources_container.append(new_resource)
              print(f"Dodano nowy zas贸b dla dnia {TODAY_DATE_STR}.")
              
              cutoff_date = TODAY_DATE - timedelta(days=MAX_HISTORY_DAYS)
              resources_to_remove = []

              for res in resources_container.findall(resource_tag):
                  resource_date = None
                  data_date_elem = res.find(data_date_tag)
                  
                  if data_date_elem is not None and data_date_elem.text:
                      try:
                          resource_date = date.fromisoformat(data_date_elem.text)
                      except ValueError:
                          pass 

                  if resource_date is not None and resource_date < cutoff_date:
                      resources_to_remove.append(res)

              for res in resources_to_remove:
                  resources_container.remove(res)
                  date_text = res.find(data_date_tag).text if res.find(data_date_tag) is not None else 'Nieznana'
                  print(f"Usunito stary zas贸b (historia > {MAX_HISTORY_DAYS} dni) z dat {date_text}.")
              
              xml_output = prettify_xml(root)
              with open(XML_FILE_NAME, 'w', encoding='utf-8') as f:
                  f.write(xml_output)
              
              print(f"\nGenerowanie zakoczone. Liczba zasob贸w w pliku XML: {len(resources_container.findall(resource_tag))}")
              print(f"Wygenerowano plik XML: {XML_FILE_NAME}")
              
              with open(XML_FILE_NAME, 'rb') as f:
                  data = f.read()

              md5_hash = hashlib.md5(data).hexdigest()
              
              with open(MD5_FILE_NAME, 'w', encoding='utf-8') as f:
                  f.write(md5_hash)
                  
              print(f"Wygenerowano plik MD5: {MD5_FILE_NAME} z hashem: {md5_hash}")

          if __name__ == "__main__":
              try:
                  generate_xml_and_md5()
              except Exception as e:
                  print(f"Wystpi krytyczny bd podczas generowania plik贸w: {e}")
          EOF
          echo "Plik generator_danych_gov.py zosta nadpisany czystym kodem."

      - name: 3. Uruchomienie skryptu generujcego XML i MD5
        run: python generator_danych_gov.py

      - name: 4. Konfiguracja GitHub Pages
        uses: actions/configure-pages@v5

      - name: 5. Wgranie artefakt贸w do Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: './'

      - name: 6. Publikacja na GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
