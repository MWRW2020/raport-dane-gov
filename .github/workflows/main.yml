# Nazwa całego procesu automatyzacji
name: Codzienne generowanie raportu dla dane.gov.pl

on:
  # Uruchamia proces automatycznie codziennie
  schedule:
    - cron: '49 22 * * *' 
  workflow_dispatch: 

# Definiuje uprawnienia
permissions:
  contents: write # KRYTYCZNE DLA AKUMULACJI
  pages: write 
  id-token: write 

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      
      # Krok 1: Twardy Reset Cache - usuwa potencjalnie buforowane pliki przed checkoutem
      - name: Hard Reset Cache (Pre-Checkout Cleanup)
        run: |
          rm -rf $GITHUB_WORKSPACE/*
          
      # Krok 2: Pobranie kodu repozytorium (Checkout)
      - name: Checkout repository (Read/Write)
        uses: actions/checkout@v3 
        with:
          token: ${{ secrets.GITHUB_TOKEN }} 

      # Krok 3: Ustawienie środowiska Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      # ***************************************************************
      # Krok 4: Uruchomienie skryptu w izolacji
      # Zamiast polegać na prostym "python skrypt.py", używamy pełnej ścieżki i pip
      # (Maksymalne wymuszenie czystego środowiska)
      - name: Run script in isolated environment
        run: |
          # Instalacja wymaganych bibliotek (jeśli są) w czystym środowisku
          pip install --upgrade pip
          # Uruchomienie skryptu Pythona
          python generator_danych_gov.py
      # ***************************************************************
          
      # Krok 5: Przygotowanie dziennego pliku z danymi (kopiowanie wzorca XLSX/CSV)
      - name: Prepare daily data file (XLSX/CSV)
        run: | 
          INWESTYCJA_ID=$(python -c "from generator_danych_gov import CONFIG; print(CONFIG['INWESTYCJA_ID'])") 
          TODAY_STR=$(date +'%Y-%m-%d')
          cp dane_wzor.xlsx "ceny-${INWESTYCJA_ID}-${TODAY_STR}.xlsx"
          
      # KROK 6: ZAPISANIE (COMMIT) ZAAKUMULOWANYCH PLIKÓW
      - name: Commit accumulated files back to main branch
        uses: stefanzweifel/git-auto-commit-action@v5 
        with:
          commit_message: "Automatyczna aktualizacja: Dodanie dziennego raportu do XML/MD5"
          file_pattern: "*.xml *.md5 *.xlsx" 
          
      # Krok 7: Spakowanie artefaktu
      - name: Upload artifact for deployment
        uses: actions/upload-pages-artifact@v3
        with:
          path: .
          
  # Zadanie 2: Publikacja strony (Deployment)
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      # Krok 8: Użycie oficjalnej akcji do publikacji strony
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
