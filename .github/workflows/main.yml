# Nazwa całego procesu automatyzacji
name: Codzienne generowanie raportu dla dane.gov.pl

on:
  # Uruchamia proces automatycznie codziennie
  # W przykładzie użyto 49 22 UTC [1], co odpowiada nocy w Polsce (po północy czasu polskiego)
  schedule:
    - cron: '49 22 * * *' 
  # Umożliwia ręczne uruchomienie procesu w interfejsie GitHub
  workflow_dispatch: 

# Definiuje uprawnienia wymagane dla automatu
permissions:
  # Użycie 'write' jest KRYTYCZNE dla AKUMULACJI [2, 3]
  contents: write 
  pages: write 
  id-token: write 

# Definiuje zadania do wykonania
jobs:
  # Zadanie 1: Generowanie plików, akumulacja i przygotowanie artefaktu
  build:
    runs-on: ubuntu-latest
    steps:
      # Krok 1: Pobranie kodu repozytorium (Checkout)
      - name: Checkout repository (Read/Write)
        uses: actions/checkout@v3 
        with:
          token: ${{ secrets.GITHUB_TOKEN }} 

      # Krok 2: Ustawienie środowiska Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      # Krok 3: Uruchomienie skryptu Pythona (Akumulacja Danych)
      - name: Run script to generate XML and MD5 (Accumulation Mode)
        run: python generator_danych_gov.py
        
      # Krok 3.1: Wymuszenie przełamania buforowania (Krok Diagnostyczny)
      - name: Force buffer refresh
        run: touch temp_reset_file.txt
          
      # Krok 4: Przygotowanie dziennego pliku z danymi (kopiowanie wzorca XLSX/CSV)
      - name: Prepare daily data file (XLSX/CSV)
        run: | 
          # POBIERANIE ZMIENNYCH Z PLIKU CONFIG W PYTHONIE
          INWESTYCJA_ID=$(python -c "from generator_danych_gov import CONFIG; print(CONFIG['INWESTYCJA_ID'])") 
          TODAY_STR=$(date +'%Y-%m-%d')
          # Kopiowanie wzorca na unikalną, datowaną nazwę
          cp dane_wzor.xlsx "ceny-${INWESTYCJA_ID}-${TODAY_STR}.xlsx"
          
      # KROK 5: ZAPISANIE (COMMIT) ZAAKUMULOWANYCH PLIKÓW
      # Ten krok GWARANTUJE AKUMULACJĘ DANYCH na potrzeby kolejnych uruchomień [4, 5].
      - name: Commit accumulated files back to main branch
        uses: stefanzweifel/git-auto-commit-action@v5 
        with:
          commit_message: "Automatyczna aktualizacja: Dodanie dziennego raportu do XML/MD5"
          file_pattern: "*.xml *.md5 *.xlsx" 
          
      # Krok 6: Spakowanie artefaktu
      - name: Upload artifact for deployment
        uses: actions/upload-pages-artifact@v3
        with:
          path: .
          
  # Zadanie 2: Publikacja strony (Deployment)
  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      # Krok 7: Użycie oficjalnej akcji do publikacji strony
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
